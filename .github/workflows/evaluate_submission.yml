name: Evaluate Submission

on:
  pull_request:
    paths:
      - 'submissions/**/*.csv'
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r starter_code/requirements.txt
        pip install pandas pyarrow scikit-learn requests gdown boto3
    
    - name: Download private test data
      env:
        PRIVATE_DATA_METHOD: ${{ secrets.PRIVATE_DATA_METHOD || 'url' }}
        PRIVATE_DATA_URL: ${{ secrets.PRIVATE_DATA_URL }}
        PRIVATE_DATA_TOKEN: ${{ secrets.PRIVATE_DATA_TOKEN }}
        GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
        GOOGLE_DRIVE_ACCESS_TOKEN: ${{ secrets.GOOGLE_DRIVE_ACCESS_TOKEN }}
        S3_BUCKET: ${{ secrets.S3_BUCKET }}
        S3_KEY: ${{ secrets.S3_KEY }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        mkdir -p data/private
        python scripts/download_private_data.py
    
    - name: Find submission files
      id: find_submissions
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          FILES=$(find submissions -name "*.csv" -not -name "sample*" | tr '\n' ' ')
        else
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^submissions/.*\.csv$' | tr '\n' ' ' || echo "")
        fi
        
        if [ -z "$FILES" ]; then
          echo "No submission files found"
          exit 1
        fi
        
        echo "files=$FILES" >> $GITHUB_OUTPUT
        echo "Found submission files: $FILES"
    
    - name: Evaluate submissions
      id: evaluate
      run: |
        mkdir -p results
        
        for FILE in ${{ steps.find_submissions.outputs.files }}; do
          if [ ! -f "$FILE" ]; then
            echo "File not found: $FILE"
            continue
          fi
          
          TEAM_NAME=$(basename "$FILE" .csv)
          echo "Evaluating $FILE (team: $TEAM_NAME)..."
          
          python scoring_script.py "$FILE" --json > "results/${TEAM_NAME}_output.txt" 2>&1 || true
          
          python scripts/extract_scores.py "$TEAM_NAME" >> results/scores.txt 2>&1 || echo "$TEAM_NAME:0.0:0.0:0.0" >> results/scores.txt
        done
        
        if [ -f results/scores.txt ]; then
          cat results/scores.txt
        fi
    
    - name: Update leaderboard
      if: success()
      run: |
        python scripts/update_leaderboard_from_scores.py
    
    - name: Generate HTML leaderboard
      run: |
        python scripts/generate_leaderboard.py
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = "## ðŸ“Š Submission Evaluation Results\n\n";
          
          const resultsDir = 'results';
          if (fs.existsSync(resultsDir)) {
            const files = fs.readdirSync(resultsDir);
            
            for (const file of files) {
              if (file.endsWith('_output.txt')) {
                const teamName = file.replace('_output.txt', '');
                const content = fs.readFileSync(path.join(resultsDir, file), 'utf8');
                comment += `### Team: ${teamName}\n\n\`\`\`\n${content}\n\`\`\`\n\n`;
              }
            }
          }
          
          comment += "The leaderboard will be updated if your submission is valid.\n";
          comment += "ðŸ‘‰ [View Leaderboard](leaderboard.html)";
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Commit and push leaderboard
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add leaderboard.json leaderboard.html
        git diff --staged --quiet || git commit -m "Auto-update leaderboard [skip ci]"
        git push || echo "Nothing to push"
