name: Evaluate Submission

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
    paths:
      - 'submissions/**/*.csv'
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
    
    - name: Fetch base branch (for PR comparison)
      if: github.event_name == 'pull_request'
      run: |
        git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} || true
        # Also fetch the base ref as a remote tracking branch
        git fetch origin ${{ github.base_ref }} || true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r starter_code/requirements.txt
        pip install pandas pyarrow scikit-learn requests gdown boto3
    
    - name: Download private test data
      env:
        PRIVATE_DATA_METHOD: ${{ secrets.PRIVATE_DATA_METHOD || 'url' }}
        PRIVATE_DATA_URL: ${{ secrets.PRIVATE_DATA_URL }}
        PRIVATE_DATA_TOKEN: ${{ secrets.PRIVATE_DATA_TOKEN }}
        GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
        GOOGLE_DRIVE_ACCESS_TOKEN: ${{ secrets.GOOGLE_DRIVE_ACCESS_TOKEN }}
        S3_BUCKET: ${{ secrets.S3_BUCKET }}
        S3_KEY: ${{ secrets.S3_KEY }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        mkdir -p data/private
        python scripts/download_private_data.py || echo "Warning: Could not download private data. Continuing anyway for testing."
    
    - name: Find submission files
      id: find_submissions
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # Manual trigger - find all CSV files in submissions/
          FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
        elif [ "${{ github.event_name }}" == "pull_request" ]; then
          # PR - find ALL CSV files in the PR branch (not just changed ones)
          # This ensures we re-evaluate on every PR update
          echo "Looking for CSV files in PR branch..."
          # First, try to find all CSV files in the current branch
          FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
          
          # If no files found, also check git-tracked files in this branch
          if [ -z "$FILES" ] || [ "$FILES" = " " ]; then
            FILES=$(git ls-files submissions/*.csv 2>/dev/null | grep -v sample | tr '\n' ' ' || echo "")
          fi
          
          # Also check for files that were added/modified in this PR
          CHANGED_FILES=$(git diff --name-only ${{ github.base_ref }}...HEAD 2>/dev/null | grep -E '^submissions/.*\.csv$' | tr '\n' ' ' || \
                          git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep -E '^submissions/.*\.csv$' | tr '\n' ' ' || echo "")
          
          # Combine both lists (remove duplicates)
          if [ -n "$CHANGED_FILES" ] && [ "$CHANGED_FILES" != " " ]; then
            ALL_FILES="$FILES $CHANGED_FILES"
            FILES=$(echo "$ALL_FILES" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          fi
        else
          # Push to main - find all CSV files (not samples) that are tracked in git
          # Also check for files that exist but might not be tracked yet
          FILES=$(git ls-files submissions/*.csv | grep -v sample | tr '\n' ' ')
          # If no tracked files, try finding all CSV files
          if [ -z "$FILES" ]; then
            FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
          fi
        fi
        
        # Clean up: remove empty strings and extra spaces
        FILES=$(echo "$FILES" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -s ' ')
        
        if [ -z "$FILES" ] || [ "$FILES" = " " ]; then
          echo "âš ï¸  No submission files found in PR"
          echo "Available files in submissions/:"
          ls -la submissions/ 2>/dev/null || echo "submissions/ directory not found"
          echo "Git tracked files:"
          git ls-files submissions/ 2>/dev/null || echo "No tracked files"
          echo "Note: This PR will be evaluated when submission files are added."
          # Don't exit with error - just skip evaluation
          echo "files=" >> $GITHUB_OUTPUT
        else
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "âœ… Found submission files: $FILES"
        fi
    
    - name: Evaluate submissions
      id: evaluate
      if: steps.find_submissions.outputs.files != ''
      run: |
        mkdir -p results
        
        for FILE in ${{ steps.find_submissions.outputs.files }}; do
          if [ ! -f "$FILE" ]; then
            echo "File not found: $FILE"
            continue
          fi
          
          TEAM_NAME=$(basename "$FILE" .csv)
          echo "Evaluating $FILE (team: $TEAM_NAME)..."
          
          python scoring_script.py "$FILE" --json > "results/${TEAM_NAME}_output.txt" 2>&1 || true
          
          python scripts/extract_scores.py "$TEAM_NAME" >> results/scores.txt 2>&1 || echo "$TEAM_NAME:0.0:0.0:0.0" >> results/scores.txt
        done
        
        if [ -f results/scores.txt ]; then
          cat results/scores.txt
        fi
    
    - name: Update leaderboard
      if: success() && steps.find_submissions.outputs.files != ''
      run: |
        # Ensure results directory exists
        mkdir -p results
        # Create empty scores.txt if it doesn't exist
        touch results/scores.txt
        python scripts/update_leaderboard_from_scores.py
    
    - name: Generate HTML leaderboard
      if: success() && steps.find_submissions.outputs.files != ''
      run: |
        python scripts/generate_leaderboard.py
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.find_submissions.outputs.files != ''
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Find existing bot comment to update it instead of creating new ones
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“Š Submission Evaluation Results')
          );
          
          let comment = "## ðŸ“Š Submission Evaluation Results\n\n";
          comment += `*Last updated: ${new Date().toISOString()}*\n\n`;
          
          const resultsDir = 'results';
          if (fs.existsSync(resultsDir)) {
            const files = fs.readdirSync(resultsDir);
            
            for (const file of files) {
              if (file.endsWith('_output.txt')) {
                const teamName = file.replace('_output.txt', '');
                const content = fs.readFileSync(path.join(resultsDir, file), 'utf8');
                comment += `### Team: ${teamName}\n\n\`\`\`\n${content}\n\`\`\`\n\n`;
              }
            }
          }
          
          comment += "The leaderboard will be updated if your submission is valid.\n";
          comment += "ðŸ‘‰ [View Leaderboard](https://samuelmatia.github.io/gnn-role-transition-challenge/leaderboard.html)";
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    - name: Commit and push leaderboard to main (immediate update like competitions)
      if: success() && steps.find_submissions.outputs.files != ''
      env:
        # Use PAT token if available (for direct push to main from PRs, like real competitions)
        # Otherwise use default GITHUB_TOKEN (works for pushes to main)
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Verify leaderboard files exist
        if [ ! -f "leaderboard.json" ] || [ ! -f "leaderboard.html" ]; then
          echo "ERROR: Leaderboard files not found!"
          exit 1
        fi
        
        # For PRs: Update main branch directly (like real competitions)
        # This works if PAT_TOKEN is configured, otherwise leaderboard is in artifacts
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # Save leaderboard files
          cp leaderboard.json leaderboard.json.bak
          cp leaderboard.html leaderboard.html.bak
          
          # Fetch and checkout main
          git fetch origin main:main || true
          git checkout main 2>/dev/null || {
            echo "Note: Cannot checkout main from PR without PAT_TOKEN."
            echo "Leaderboard is available in artifacts and will be in main after merge."
            exit 0
          }
          
          # Restore leaderboard files
          mv leaderboard.json.bak leaderboard.json
          mv leaderboard.html.bak leaderboard.html
        fi
        
        # Add leaderboard files
        git add leaderboard.json leaderboard.html
        
        # Also ensure any submission files that exist but aren't tracked are added
        if [ -d "submissions" ]; then
          for file in submissions/*.csv; do
            if [ -f "$file" ] && ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
              echo "Adding untracked submission file: $file"
              git add "$file"
            fi
          done
        fi
        
        # Commit and push
        if git diff --staged --quiet; then
          echo "No changes to commit in leaderboard"
        else
          git commit -m "Auto-update leaderboard [skip ci]" || echo "Commit failed"
          git push origin main || echo "Note: Push may require PAT_TOKEN for PRs. Leaderboard available in artifacts."
        fi
    
    - name: Upload leaderboard artifacts (for PR)
      if: success() && github.event_name == 'pull_request' && steps.find_submissions.outputs.files != ''
      uses: actions/upload-artifact@v4
      with:
        name: leaderboard-update
        path: |
          leaderboard.json
          leaderboard.html
        retention-days: 1
