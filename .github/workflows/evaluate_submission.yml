name: Evaluate Submission

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
    paths:
      - 'submissions/**/*.csv'
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
    
    - name: Fetch base branch (for PR comparison)
      if: github.event_name == 'pull_request'
      run: |
        git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} || true
        git fetch origin ${{ github.base_ref }} || true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r starter_code/requirements.txt
        pip install pandas pyarrow scikit-learn requests gdown boto3
    
    - name: Download private test data
      env:
        PRIVATE_DATA_METHOD: ${{ secrets.PRIVATE_DATA_METHOD || 'url' }}
        PRIVATE_DATA_URL: ${{ secrets.PRIVATE_DATA_URL }}
        PRIVATE_DATA_TOKEN: ${{ secrets.PRIVATE_DATA_TOKEN }}
        GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
        GOOGLE_DRIVE_ACCESS_TOKEN: ${{ secrets.GOOGLE_DRIVE_ACCESS_TOKEN }}
        S3_BUCKET: ${{ secrets.S3_BUCKET }}
        S3_KEY: ${{ secrets.S3_KEY }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        mkdir -p data/private
        python scripts/download_private_data.py || echo "Warning: Could not download private data. Continuing anyway for testing."
    
    - name: Find submission files
      id: find_submissions
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # Manual trigger - find all CSV files
          FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
        elif [ "${{ github.event_name }}" == "pull_request" ]; then
          # PR - find ALL CSV files in the PR branch
          echo "üîç Looking for CSV files in PR branch..."
          
          # Find all CSV files in current branch
          FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
          
          # Also check git-tracked files
          if [ -z "$FILES" ] || [ "$FILES" = " " ]; then
            FILES=$(git ls-files submissions/*.csv 2>/dev/null | grep -v sample | tr '\n' ' ' || echo "")
          fi
          
          # Also include files changed in this PR
          CHANGED=$(git diff --name-only ${{ github.base_ref }}...HEAD 2>/dev/null | grep -E '^submissions/.*\.csv$' | tr '\n' ' ' || echo "")
          
          # Combine and deduplicate
          if [ -n "$CHANGED" ] && [ "$CHANGED" != " " ]; then
            ALL_FILES="$FILES $CHANGED"
            FILES=$(echo "$ALL_FILES" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          fi
        else
          # Push to main - find all CSV files
          FILES=$(git ls-files submissions/*.csv | grep -v sample | tr '\n' ' ' || echo "")
          if [ -z "$FILES" ]; then
            FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
          fi
        fi
        
        # Clean up
        FILES=$(echo "$FILES" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -s ' ')
        
        if [ -z "$FILES" ] || [ "$FILES" = " " ]; then
          echo "‚ö†Ô∏è  No submission files found"
          ls -la submissions/ 2>/dev/null || echo "submissions/ directory not found"
          echo "files=" >> $GITHUB_OUTPUT
        else
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "‚úÖ Found submission files: $FILES"
        fi
    
    - name: Evaluate submissions
      id: evaluate
      if: steps.find_submissions.outputs.files != ''
      run: |
        mkdir -p results
        
        for FILE in ${{ steps.find_submissions.outputs.files }}; do
          if [ ! -f "$FILE" ]; then
            echo "‚ö†Ô∏è  File not found: $FILE"
            continue
          fi
          
          TEAM_NAME=$(basename "$FILE" .csv)
          echo "üìä Evaluating $FILE (team: $TEAM_NAME)..."
          
          python scoring_script.py "$FILE" --json > "results/${TEAM_NAME}_output.txt" 2>&1 || true
          
          python scripts/extract_scores.py "$TEAM_NAME" >> results/scores.txt 2>&1 || echo "$TEAM_NAME:0.0:0.0:0.0" >> results/scores.txt
        done
        
        if [ -f results/scores.txt ]; then
          echo "üìà Evaluation results:"
          cat results/scores.txt
        fi
    
    - name: Update leaderboard
      if: success() && steps.find_submissions.outputs.files != ''
      run: |
        mkdir -p results
        touch results/scores.txt
        python scripts/update_leaderboard_from_scores.py
    
    - name: Generate HTML leaderboard
      if: success() && steps.find_submissions.outputs.files != ''
      run: |
        python scripts/generate_leaderboard.py
    
    - name: Update leaderboard in PR branch
      if: success() && github.event_name == 'pull_request' && steps.find_submissions.outputs.files != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ ! -f "leaderboard.json" ] || [ ! -f "leaderboard.html" ]; then
          echo "‚ùå ERROR: Leaderboard files not found!"
          exit 1
        fi
        
        git add leaderboard.json leaderboard.html
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit in leaderboard"
        else
          git commit -m "Auto-update leaderboard from evaluation [skip ci]" || {
            echo "‚ùå Commit failed"
            exit 1
          }
          
          git push origin HEAD:${{ github.event.pull_request.head.ref }} || {
            echo "‚ùå Push to PR branch failed"
            exit 1
          }
          
          echo "‚úÖ Leaderboard updated in PR branch"
        fi
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.find_submissions.outputs.files != ''
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Find existing bot comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('üìä Submission Evaluation Results')
          );
          
          let comment = "## üìä Submission Evaluation Results\n\n";
          comment += `*Last updated: ${new Date().toISOString()}*\n\n`;
          
          const resultsDir = 'results';
          if (fs.existsSync(resultsDir)) {
            const files = fs.readdirSync(resultsDir);
            
            for (const file of files) {
              if (file.endsWith('_output.txt')) {
                const teamName = file.replace('_output.txt', '');
                const content = fs.readFileSync(path.join(resultsDir, file), 'utf8');
                comment += `### Team: ${teamName}\n\n\`\`\`\n${content}\n\`\`\`\n\n`;
              }
            }
          }
          
          comment += "The leaderboard has been updated in this PR branch.\n";
          comment += "üëâ [View Leaderboard](https://samuelmatia.github.io/gnn-role-transition-challenge/leaderboard.html)";
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
    
    - name: Push leaderboard to main (if PAT_TOKEN available)
      if: success() && github.event_name == 'pull_request' && steps.find_submissions.outputs.files != ''
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        if [ -z "$PAT_TOKEN" ]; then
          echo "‚ÑπÔ∏è  PAT_TOKEN not configured. Leaderboard updated in PR branch only."
          echo "‚úÖ Leaderboard will be updated on main automatically when PR is merged."
          exit 0
        fi
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ ! -f "leaderboard.json" ] || [ ! -f "leaderboard.html" ]; then
          echo "‚ùå ERROR: Leaderboard files not found!"
          exit 1
        fi
        
        # Save files
        cp leaderboard.json /tmp/leaderboard.json.bak
        cp leaderboard.html /tmp/leaderboard.html.bak
        
        # Configure remote with PAT
        git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}.git
        
        # Stash and checkout main
        git stash push -m "Stash before checkout" || true
        
        git fetch origin main:main || {
          echo "‚ùå Failed to fetch main"
          git stash pop || true
          exit 1
        }
        
        git checkout main || {
          echo "‚ùå Failed to checkout main"
          git stash pop || true
          exit 1
        }
        
        # Restore files
        cp /tmp/leaderboard.json.bak leaderboard.json
        cp /tmp/leaderboard.html.bak leaderboard.html
        
        git add leaderboard.json leaderboard.html
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit on main"
        else
          git commit -m "Auto-update leaderboard [skip ci]" || {
            echo "‚ùå Commit failed"
            exit 1
          }
          
          git push origin main || {
            echo "‚ùå Push failed"
            exit 1
          }
          
          echo "‚úÖ Leaderboard pushed to main branch"
          echo "üöÄ GitHub Pages will deploy automatically"
        fi
    
    - name: Commit and push leaderboard (for push to main)
      if: success() && github.event_name != 'pull_request' && steps.find_submissions.outputs.files != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add leaderboard.json leaderboard.html
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to commit"
        else
          git commit -m "Auto-update leaderboard [skip ci]" || {
            echo "‚ùå Commit failed"
            exit 1
          }
          
          git push origin main || {
            echo "‚ùå Push failed"
            exit 1
          }
          
          echo "‚úÖ Leaderboard updated on main"
          echo "üöÄ GitHub Pages will deploy automatically"
        fi
    
    - name: Upload leaderboard artifacts
      if: success() && github.event_name == 'pull_request' && steps.find_submissions.outputs.files != ''
      uses: actions/upload-artifact@v4
      with:
        name: leaderboard-update
        path: |
          leaderboard.json
          leaderboard.html
        retention-days: 1
