name: Evaluate Submission

on:
  pull_request:
    paths:
      - 'submissions/**/*.csv'
  push:
    branches:
      - main
    paths:
      - 'submissions/**/*.csv'
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
    
    - name: Fetch base branch (for PR comparison)
      if: github.event_name == 'pull_request'
      run: |
        git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} || true
        # Also fetch the base ref as a remote tracking branch
        git fetch origin ${{ github.base_ref }} || true
        # Fetch main to get latest leaderboard
        git fetch origin main:main || true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r starter_code/requirements.txt
        pip install pandas pyarrow scikit-learn requests gdown boto3
    
    - name: Download private test data
      env:
        PRIVATE_DATA_METHOD: ${{ secrets.PRIVATE_DATA_METHOD || 'url' }}
        PRIVATE_DATA_URL: ${{ secrets.PRIVATE_DATA_URL }}
        PRIVATE_DATA_TOKEN: ${{ secrets.PRIVATE_DATA_TOKEN }}
        GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
        GOOGLE_DRIVE_ACCESS_TOKEN: ${{ secrets.GOOGLE_DRIVE_ACCESS_TOKEN }}
        S3_BUCKET: ${{ secrets.S3_BUCKET }}
        S3_KEY: ${{ secrets.S3_KEY }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        mkdir -p data/private
        python scripts/download_private_data.py || echo "Warning: Could not download private data. Continuing anyway for testing."
    
    - name: Find submission files
      id: find_submissions
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # Manual trigger - find all CSV files in submissions/
          FILES=$(find submissions -name "*.csv" -not -name "sample*" | tr '\n' ' ')
        elif [ "${{ github.event_name }}" == "pull_request" ]; then
          # PR - find changed CSV files
          # Try both origin/base_ref and local base_ref (after fetch)
          FILES=$(git diff --name-only ${{ github.base_ref }}...HEAD 2>/dev/null | grep -E '^submissions/.*\.csv$' | tr '\n' ' ' || \
                  git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep -E '^submissions/.*\.csv$' | tr '\n' ' ' || echo "")
        else
          # Push to main - find all CSV files (not samples) that are tracked in git
          # Also check for files that exist but might not be tracked yet
          FILES=$(git ls-files submissions/*.csv | grep -v sample | tr '\n' ' ')
          # If no tracked files, try finding all CSV files
          if [ -z "$FILES" ]; then
            FILES=$(find submissions -name "*.csv" -not -name "sample*" 2>/dev/null | tr '\n' ' ' || echo "")
          fi
        fi
        
        if [ -z "$FILES" ]; then
          echo "No submission files found"
          echo "Available files in submissions/:"
          ls -la submissions/ || echo "submissions/ directory not found"
          echo "Git tracked files:"
          git ls-files submissions/ || echo "No tracked files"
          exit 1
        fi
        
        echo "files=$FILES" >> $GITHUB_OUTPUT
        echo "Found submission files: $FILES"
    
    - name: Evaluate submissions
      id: evaluate
      run: |
        mkdir -p results
        
        for FILE in ${{ steps.find_submissions.outputs.files }}; do
          if [ ! -f "$FILE" ]; then
            echo "File not found: $FILE"
            continue
          fi
          
          TEAM_NAME=$(basename "$FILE" .csv)
          echo "Evaluating $FILE (team: $TEAM_NAME)..."
          
          python scoring_script.py "$FILE" --json > "results/${TEAM_NAME}_output.txt" 2>&1 || true
          
          # Extract scores (capture both stdout and stderr)
          SCORE_OUTPUT=$(python scripts/extract_scores.py "$TEAM_NAME" 2>&1)
          if [ $? -eq 0 ] && [ -n "$SCORE_OUTPUT" ]; then
            echo "$SCORE_OUTPUT" >> results/scores.txt
            echo "Added score for $TEAM_NAME: $SCORE_OUTPUT"
          else
            echo "$TEAM_NAME:0.0:0.0:0.0" >> results/scores.txt
            echo "Warning: Failed to extract scores for $TEAM_NAME, using default 0.0:0.0:0.0"
          fi
        done
        
        if [ -f results/scores.txt ]; then
          echo "=== Contents of results/scores.txt ==="
          cat results/scores.txt
          echo "=== End of scores.txt ==="
        else
          echo "WARNING: results/scores.txt does not exist!"
        fi
    
    - name: Load latest leaderboard from main
      if: success() && github.event_name == 'pull_request'
      run: |
        # Copy latest leaderboard.json from main branch to ensure we have all existing submissions
        if git show main:leaderboard.json > leaderboard.json 2>/dev/null; then
          echo "Loaded latest leaderboard from main branch"
        else
          echo "No leaderboard.json in main, starting fresh"
          echo '{"last_updated": null, "submissions": []}' > leaderboard.json
        fi
    
    - name: Update leaderboard
      if: success()
      run: |
        # Ensure results directory exists
        mkdir -p results
        # Debug: Show what we have
        echo "=== Debug: Checking scores.txt ==="
        if [ -f results/scores.txt ]; then
          echo "scores.txt exists"
          echo "Size: $(wc -l < results/scores.txt) lines"
          echo "Content:"
          cat results/scores.txt || echo "Could not read file"
        else
          echo "scores.txt does NOT exist"
        fi
        echo "=== End Debug ==="
        
        # Only update leaderboard if scores.txt exists and has content
        if [ -f results/scores.txt ] && [ -s results/scores.txt ]; then
          echo "Updating leaderboard..."
          python scripts/update_leaderboard_from_scores.py
          echo "Leaderboard update completed"
        else
          echo "No scores found in results/scores.txt, skipping leaderboard update"
          echo "This may happen if evaluation failed or no valid submissions were found"
        fi
    
    - name: Generate HTML leaderboard
      if: success()
      run: |
        echo "=== Generating HTML leaderboard ==="
        python scripts/generate_leaderboard.py
        echo "=== Checking leaderboard.json ==="
        if [ -f leaderboard.json ]; then
          echo "leaderboard.json exists"
          echo "Number of submissions: $(cat leaderboard.json | grep -c '\"team\"' || echo '0')"
          echo "Teams in leaderboard:"
          cat leaderboard.json | grep '"team"' | head -10
        else
          echo "ERROR: leaderboard.json does not exist!"
        fi
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = "## ðŸ“Š Submission Evaluation Results\n\n";
          
          const resultsDir = 'results';
          if (fs.existsSync(resultsDir)) {
            const files = fs.readdirSync(resultsDir);
            
            for (const file of files) {
              if (file.endsWith('_output.txt')) {
                const teamName = file.replace('_output.txt', '');
                const content = fs.readFileSync(path.join(resultsDir, file), 'utf8');
                comment += `### Team: ${teamName}\n\n\`\`\`\n${content}\n\`\`\`\n\n`;
              }
            }
          }
          
          comment += "The leaderboard will be updated if your submission is valid.\n";
          comment += "ðŸ‘‰ [View Leaderboard](https://samuelmatia.github.io/gnn-role-transition-challenge/leaderboard.html)";
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Update leaderboard in main immediately (like competitions)
      if: success() && github.event_name == 'pull_request'
      env:
        # Use PAT token for direct push to main from PR (like real competitions)
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Verify leaderboard files exist
        if [ ! -f "leaderboard.json" ] || [ ! -f "leaderboard.html" ]; then
          echo "ERROR: Leaderboard files not found!"
          exit 1
        fi
        
        # Save leaderboard files
        cp leaderboard.json leaderboard.json.bak
        cp leaderboard.html leaderboard.html.bak
        
        # Fetch and checkout main branch
        echo "Fetching main branch..."
        git fetch origin main:main || {
          echo "ERROR: Could not fetch main branch"
          exit 1
        }
        
        echo "Checking out main branch..."
        git checkout main || {
          echo "ERROR: Could not checkout main branch"
          echo "Note: This requires PAT_TOKEN secret to be configured"
          echo "Leaderboard is available in artifacts and will be in main after merge"
          exit 0
        }
        
        # Restore leaderboard files
        mv leaderboard.json.bak leaderboard.json
        mv leaderboard.html.bak leaderboard.html
        
        # Add leaderboard files
        git add leaderboard.json leaderboard.html
        
        # Commit and push to main
        if git diff --staged --quiet; then
          echo "No changes to commit in leaderboard"
        else
          echo "Committing leaderboard update to main..."
          git commit -m "Auto-update leaderboard after PR evaluation [skip ci]" || {
            echo "ERROR: Commit failed"
            exit 1
          }
          
          echo "Pushing to main..."
          git push origin main || {
            echo "ERROR: Push to main failed"
            echo "This usually means PAT_TOKEN is not configured or doesn't have write permissions"
            echo "Leaderboard is available in artifacts and will be in main after merge"
            exit 1
          }
          
          echo "âœ… Leaderboard successfully updated in main!"
        fi
    
    - name: Commit and push leaderboard to main
      if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Verify leaderboard files exist
        if [ ! -f "leaderboard.json" ] || [ ! -f "leaderboard.html" ]; then
          echo "ERROR: Leaderboard files not found!"
          exit 1
        fi
        
        # Add leaderboard files
        git add leaderboard.json leaderboard.html
        
        # Also ensure any submission files that exist but aren't tracked are added
        if [ -d "submissions" ]; then
          for file in submissions/*.csv; do
            if [ -f "$file" ] && ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
              echo "Adding untracked submission file: $file"
              git add "$file"
            fi
          done
        fi
        
        # Commit and push
        if git diff --staged --quiet; then
          echo "No changes to commit in leaderboard"
        else
          git commit -m "Auto-update leaderboard [skip ci]" || echo "Commit failed"
          git push || echo "Push failed"
        fi
    
    - name: Upload leaderboard artifacts (for PR)
      if: success() && github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: leaderboard-update
        path: |
          leaderboard.json
          leaderboard.html
        retention-days: 1
